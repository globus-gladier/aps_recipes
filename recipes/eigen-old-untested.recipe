# Name: eigen
# Version: 1.0.0
# Description: Container for XPCS Eigen correlation analysis
# Maintainer: Gladier APS Team <gladier@globus-aps.org>
# Base Image: docker.io/continuumio/miniconda3:latest
# Last Updated: 2024-03-19

# Use the fully qualified Miniconda3 image from Docker Hub.
FROM docker.io/continuumio/miniconda3:latest

# Set environment variables
ENV PATH="/container/miniconda/bin:$PATH" \
    DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && \
    apt-get install -y \
        wget \
        git \
        build-essential \
        cmake \
        make \
        libeigen3-dev \
        libhdf5-dev \
        libgflags-dev \
        libspdlog-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf Music/ Public/ Videos/ Templates/ Pictures/ Documents/ examples.desktop

# Create container directory and clone repository
WORKDIR /container
RUN git clone --recurse-submodules https://github.com/AdvancedPhotonSource/xpcs-eigen.git

# Build xpcs-eigen
WORKDIR /container/xpcs-eigen
RUN mkdir build && \
    cd build && \
    cmake ../ && \
    make -j

# Configure conda and install Python packages
RUN conda config --set always_yes yes --set changeps1 no --set auto_update_conda yes && \
    conda install -y conda-build anaconda-client && \
    conda update -y conda && \
    conda install -y numpy h5py pip && \
    conda clean -afy

# Create symbolic links
RUN ln -s /container/xpcs-eigen/build/corr /corr && \
    ln -s /container/xpcs-eigen/build/corr /usr/bin/corr

# Set working directory
WORKDIR /container

# Clean up
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install globus-compute-endpoint via pip
RUN pip install --no-cache-dir globus-compute-endpoint

# Default command: launch a bash terminal.
CMD ["/bin/bash"]
